/*
 * @svg-drawing/img-trace v5.0.1-beta.0 
 * 
 * Copyright (C) Kazuto Kamei.
 * This source code is licensed under the MIT license.
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@svg-drawing/core");function n(t,n,i){return n in t?Object.defineProperty(t,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[n]=i,t}function i(){return i=Object.assign||function(t){for(var n=1;n<arguments.length;n++){var i=arguments[n];for(var o in i)Object.prototype.hasOwnProperty.call(i,o)&&(t[o]=i[o])}return t},i.apply(this,arguments)}var o=function(t){var n=t.width*t.height;if(!(t.data.length<4*n))return t;for(var o=new Uint8ClampedArray(4*n),r=0;r<n;r++)o[4*r]=t.data[3*r],o[4*r+1]=t.data[3*r+1],o[4*r+2]=t.data[3*r+2],o[4*r+3]=255;return i({},t,{data:o})},r=[[.27901,.44198,.27901],[.135336,.228569,.272192,.228569,.135336],[.086776,.136394,.178908,.195843,.178908,.136394,.086776],[.063327,.093095,.122589,.144599,.152781,.144599,.122589,.093095,.063327],[.049692,.069304,.089767,.107988,.120651,.125194,.120651,.107988,.089767,.069304,.049692]],a=function(){function t(t){var i=t.radius,o=t.delta;n(this,"radius",void 0),n(this,"delta",void 0),this.radius=null!=i?i:0,this.delta=null!=o?o:20}return t.prototype.apply=function(t){var n=o(t),i=new Uint8ClampedArray(n.data),a=Math.floor(this.radius);if(a<1)return n;a>r.length&&(a=r.length);var e=Math.abs(this.delta);e>1024&&(e=1024);for(var s=r[a-1],h=0;h<n.height;h++)for(var p=0;p<n.width;p++){for(var l=0,d=0,u=0,f=0,c=0,g=-a;g<a+1;g++)if(p+g>0&&p+g<n.width){var v=4*(h*n.width+p+g);l+=n.data[v]*s[g+a],d+=n.data[v+1]*s[g+a],u+=n.data[v+2]*s[g+a],f+=n.data[v+3]*s[g+a],c+=s[g+a]}var b=4*(h*n.width+p);i[b]=Math.floor(l/c),i[b+1]=Math.floor(d/c),i[b+2]=Math.floor(u/c),i[b+3]=Math.floor(f/c)}for(var y=new Uint8ClampedArray(i),x=0;x<n.height;x++)for(var m=0;m<n.width;m++){for(var w=0,M=0,_=0,P=0,O=0,C=-a;C<a+1;C++)if(x+C>0&&x+C<n.height){var q=4*((x+C)*n.width+m);w+=y[q]*s[C+a],M+=y[q+1]*s[C+a],_+=y[q+2]*s[C+a],P+=y[q+3]*s[C+a],O+=s[C+a]}var A=4*(x*n.width+m);i[A]=Math.floor(w/O),i[A+1]=Math.floor(M/O),i[A+2]=Math.floor(_/O),i[A+3]=Math.floor(P/O)}for(var I=0;I<n.height;I++)for(var D=0;D<n.width;D++){var j=4*(I*n.width+D);Math.abs(i[j]-n.data[j])+Math.abs(i[j+1]-n.data[j+1])+Math.abs(i[j+2]-n.data[j+2])+Math.abs(i[j+3]-n.data[j+3])>e&&(i[j]=n.data[j],i[j+1]=n.data[j+1],i[j+2]=n.data[j+2],i[j+3]=n.data[j+3])}return new ImageData(i,n.width,n.height)},t}(),e=function(){function t(t){var i;n(this,"corsenabled",void 0),this.corsenabled=null==(i=t.corsenabled)||i}var i=t.prototype;return i.fromUrl=function(t,n){var i=this,o=function(n,o){var r=new Image;i.corsenabled&&(r.crossOrigin="Anonymous"),r.onload=function(){i.fromImageElement(r,n)},r.onerror=function(t){o?o(t):console.error(t)},r.src=t};if(!n)return new Promise(o);o(n)},i.fromImageElement=function(t,n){var i=function(n,i){var o=document.createElement("canvas");o.width=t.naturalWidth||t.width,o.height=t.naturalHeight||t.height;var r=o.getContext("2d");null==r||r.drawImage(t,0,0);var a=null==r?void 0:r.getImageData(0,0,o.width,o.height);if(!a){if(i)return void i("error canvas context.");throw"error canvas context."}n(a)};if(!n)return new Promise(i);i(n)},t}(),s=function(){function t(){}return t.imageData=function(t,n){for(var i=void 0===n?{}:n,r=i.numberOfColors||16,a=i.colorQuantCycles||3,e=o(t),s=this._deterministic(e,r),h=[],p=0;p<a;p++){if(p>0)for(var l=0;l<s.length;l++)h[l].n>0&&(s[l]={r:Math.floor(h[l].r/h[l].n),g:Math.floor(h[l].g/h[l].n),b:Math.floor(h[l].b/h[l].n),a:Math.floor(h[l].a/h[l].n)});h=Array.from({length:s.length},(function(){return{r:0,g:0,b:0,a:0,n:0}}));for(var d=0;d<e.height;d++)for(var u=function(t){var n=4*(d*e.width+t),i=1024,o=s.reduce((function(t,o,r){var a=Math.abs(o.r-e.data[n])+Math.abs(o.g-e.data[n+1])+Math.abs(o.b-e.data[n+2])+Math.abs(o.a-e.data[n+3]);return a<i?(i=a,r):t}),0);h[o].r+=e.data[n],h[o].g+=e.data[n+1],h[o].b+=e.data[n+2],h[o].a+=e.data[n+3],h[o].n+=1},f=0;f<e.width;f++)u(f)}return s},t._deterministic=function(t,n){for(var i=[],o=Math.ceil(Math.sqrt(n)),r=Math.ceil(n/o),a=t.width/(o+1),e=t.height/(r+1),s=0;s<r;s++)for(var h=0;h<o&&i.length!==n;h++){var p=4*Math.floor((s+1)*e*t.width+(h+1)*a);i.push({r:t.data[p],g:t.data[p+1],b:t.data[p+2],a:t.data[p+3]})}return i},t.number=function(t){if(void 0===t&&(t=16),t<8)return this.grey(t);for(var n=[],i=Math.floor(Math.pow(t,1/3)),o=Math.floor(255/(i-1)),r=0;r<i;r+=1)for(var a=0;a<i;a+=1)for(var e=0;e<i;e+=1)n.push({r:r*o,g:a*o,b:e*o,a:255});for(var s=t-i*i*i,h=0;h<s;h++)n.push({r:Math.floor(255*Math.random()),g:Math.floor(255*Math.random()),b:Math.floor(255*Math.random()),a:Math.floor(255*Math.random())});return n},t.grey=function(t){void 0===t&&(t=16);for(var n=[],i=Math.floor(255/(t-1)),o=0;o<t;o++)n.push({r:o*i,g:o*i,b:o*i,a:255});return n},t}(),h=0,p=1,l=2,d=3,u=4,f=5,c=6,g=7,v=8,b=-1,y=[[[-1,-1,-1,-1],[-1,-1,-1,-1],[-1,-1,-1,-1],[-1,-1,-1,-1]],[[0,1,0,-1],[-1,-1,-1,-1],[-1,-1,-1,-1],[0,2,-1,0]],[[-1,-1,-1,-1],[-1,-1,-1,-1],[0,1,0,-1],[0,0,1,0]],[[0,0,1,0],[-1,-1,-1,-1],[0,2,-1,0],[-1,-1,-1,-1]],[[-1,-1,-1,-1],[0,0,1,0],[0,3,0,1],[-1,-1,-1,-1]],[[13,3,0,1],[13,2,-1,0],[7,1,0,-1],[7,0,1,0]],[[-1,-1,-1,-1],[0,1,0,-1],[-1,-1,-1,-1],[0,3,0,1]],[[0,3,0,1],[0,2,-1,0],[-1,-1,-1,-1],[-1,-1,-1,-1]],[[0,3,0,1],[0,2,-1,0],[-1,-1,-1,-1],[-1,-1,-1,-1]],[[-1,-1,-1,-1],[0,1,0,-1],[-1,-1,-1,-1],[0,3,0,1]],[[11,1,0,-1],[14,0,1,0],[14,3,0,1],[11,2,-1,0]],[[-1,-1,-1,-1],[0,0,1,0],[0,3,0,1],[-1,-1,-1,-1]],[[0,0,1,0],[-1,-1,-1,-1],[0,2,-1,0],[-1,-1,-1,-1]],[[-1,-1,-1,-1],[-1,-1,-1,-1],[0,1,0,-1],[0,0,1,0]],[[0,1,0,-1],[-1,-1,-1,-1],[-1,-1,-1,-1],[0,2,-1,0]],[[-1,-1,-1,-1],[-1,-1,-1,-1],[-1,-1,-1,-1],[-1,-1,-1,-1]]],x=[{r:0,g:0,b:0,a:255},{r:50,g:50,b:50,a:255},{r:100,g:100,b:100,a:255},{r:150,g:150,b:150,a:255},{r:200,g:200,b:200,a:255}],m=function(){function r(t){var o,r,a,e,s;void 0===t&&(t={}),n(this,"ltres",void 0),n(this,"qtres",void 0),n(this,"rightangleenhance",void 0),n(this,"pathOmit",void 0),n(this,"commandOmit",void 0),n(this,"pathAttrs",void 0),n(this,"palettes",void 0),this.ltres=null!=(o=t.ltres)?o:1,this.qtres=null!=(r=t.qtres)?r:1,this.rightangleenhance=null==(a=t.rightangleenhance)||a,this.pathOmit=null!=(e=t.pathOmit)?e:8,this.commandOmit=null!=(s=t.commandOmit)?s:0,this.pathAttrs=i({strokeWidth:"1"},t.pathAttrs||{}),this.palettes=t.palettes||x}var a=r.prototype;return a.load=function(n){for(var i=o(n),r=this._colorQuantization(i),a=[],e=0;e<this.palettes.length;e++){var s=this._edgeDetection(r,e),h=this._pathScan(s),p=this._interpolation(h).map(this._tracePath.bind(this));a.push(p)}var l=this._createPaths(a);return new t.Svg({width:r[0].length-2,height:r.length-2}).addPath(l)},a._colorQuantization=function(t){var n=this;return Array.from({length:t.height+2},(function(i,o){return Array.from({length:t.width+2},(function(i,r){if(0===r||r===t.width+1||0===o||o===t.height+1)return-1;var a=r-1,e=4*((o-1)*t.width+a);return n._findPaletteIndex({r:t.data[e],g:t.data[e+1],b:t.data[e+2],a:t.data[e+3]})}))}))},a._findPaletteIndex=function(t){var n=t.r,i=t.g,o=t.b,r=t.a,a=1024;return this.palettes.reduce((function(t,e,s){var h=Math.abs(e.r-n)+Math.abs(e.g-i)+Math.abs(e.b-o)+Math.abs(e.a-r);return h<a?(a=h,s):t}),0)},a._edgeDetection=function(t,n){for(var i=[],o=t.length,r=t[0].length,a=0;a<o;a++){i[a]=[];for(var e=0;e<r;e++)i[a][e]=0===a||0===e?0:(t[a-1][e-1]===n?1:0)+(t[a-1][e]===n?2:0)+(t[a][e-1]===n?8:0)+(t[a][e]===n?4:0)}return i},a._pointpoly=function(t,n){for(var i=!1,o=0,r=n.length-1;o<n.length;r=o++)i=n[o].y>t.y!=n[r].y>t.y&&t.x<(n[r].x-n[o].x)*(t.y-n[o].y)/(n[r].y-n[o].y)+n[o].x?!i:i;return i},a._pathScan=function(t){for(var n=t[0].length,i=t.length,o=[],r=0,a=0;a<i;a++)for(var e=0;e<n;e++){var s=t[a][e];if(4===s||11===s){var h=e,p=a,l=1,d=0,u=!1;for(o[r]={points:[],boundingbox:[h,p,h,p],holechildren:[],isholepath:!1};!u;){o[r].points[d]={x:h-1,y:p-1,direction:b},h-1<o[r].boundingbox[0]&&(o[r].boundingbox[0]=h-1),h-1>o[r].boundingbox[2]&&(o[r].boundingbox[2]=h-1),p-1<o[r].boundingbox[1]&&(o[r].boundingbox[1]=p-1),p-1>o[r].boundingbox[3]&&(o[r].boundingbox[3]=p-1);var f=y[t[p][h]][l];if(t[p][h]=f[0],l=f[1],h+=f[2],p+=f[3],h-1===o[r].points[0].x&&p-1===o[r].points[0].y)if(u=!0,o[r].points.length<this.pathOmit)o.pop();else{if(11===s){o[r].isholepath=!0;for(var c=0,g=[-1,-1,n+1,i+1],v=0;v<r;v++)!o[v].isholepath&&this._boundingboxincludes(o[v].boundingbox,o[r].boundingbox)&&this._boundingboxincludes(g,o[v].boundingbox)&&this._pointpoly(o[r].points[0],o[v].points)&&(c=v,g=o[v].boundingbox);o[c].holechildren.push(r)}r++}d++}}}return o},a._boundingboxincludes=function(t,n){return t[0]<n[0]&&t[1]<n[1]&&t[2]>n[2]&&t[3]>n[3]},a._interpolation=function(t){for(var n=[],i=0,o=0,r=0,a=0,e=0;e<t.length;e++){n[e]={points:[],boundingbox:t[e].boundingbox,holechildren:t[e].holechildren,isholepath:t[e].isholepath};for(var s=t[e].points.length,h=0;h<s;h++)i=(h+1)%s,o=(h+2)%s,r=(h-1+s)%s,a=(h-2+s)%s,this.rightangleenhance&&this._testrightangle(t[e],a,r,h,i,o)&&(n[e].points.length>0&&(n[e].points[n[e].points.length-1].direction=this._getdirection(n[e].points[n[e].points.length-1].x,n[e].points[n[e].points.length-1].y,t[e].points[h].x,t[e].points[h].y)),n[e].points.push({x:t[e].points[h].x,y:t[e].points[h].y,direction:this._getdirection(t[e].points[h].x,t[e].points[h].y,(t[e].points[h].x+t[e].points[i].x)/2,(t[e].points[h].y+t[e].points[i].y)/2)})),n[e].points.push({x:(t[e].points[h].x+t[e].points[i].x)/2,y:(t[e].points[h].y+t[e].points[i].y)/2,direction:this._getdirection(t[e].points[h].x+t[e].points[i].x,t[e].points[h].y+t[e].points[i].y,t[e].points[i].x+t[e].points[o].x,t[e].points[i].y+t[e].points[o].y)})}return n},a._testrightangle=function(t,n,i,o,r,a){return t.points[o].x===t.points[n].x&&t.points[o].x===t.points[i].x&&t.points[o].y===t.points[r].y&&t.points[o].y===t.points[a].y||t.points[o].y===t.points[n].y&&t.points[o].y===t.points[i].y&&t.points[o].x===t.points[r].x&&t.points[o].x===t.points[a].x},a._getdirection=function(t,n,i,o){return t<i?n<o?p:g:t>i?n<o?d:n>o?f:u:n<o?l:n>o?c:v},a._tracePath=function(n){for(var i=0,o=[],r=[];i<n.points.length;){for(var a=n.points[i].direction,e=b,s=i+1;(n.points[s].direction===a||n.points[s].direction===e||-1===e)&&s<n.points.length-1;)n.points[s].direction!==a&&e===b&&(e=n.points[s].direction||h),s++;s===n.points.length-1?(o.push.apply(o,this._fitseq(n,i,0)),r.push.apply(r,this._fitseq(n,i,0,!0)),i=n.points.length):(o.push.apply(o,this._fitseq(n,i,s)),r.push.apply(r,this._fitseq(n,i,s,!0)),i=s)}var p=[new t.Move(new t.Point(n.points[0].x,n.points[0].y))].concat(o,[new t.Close]);r.reverse();var l=r[r.length-1].values.slice(0,2);return{commands:p,holeCommands:[new t.Move(new t.Point(l[0],l[1]))].concat(r,[new t.Close]),holechildren:n.holechildren,isholepath:n.isholepath}},a._fitseq=function(n,i,o,r){var a=this.ltres,e=this.qtres;if(o>n.points.length||o<0)return[];var s,h,p,l=i,d=0,u=!0,f=o-i;f<0&&(f+=n.points.length);for(var c=(n.points[o].x-n.points[i].x)/f,g=(n.points[o].y-n.points[i].y)/f,v=(i+1)%n.points.length;v!=o;){var b=v-i;b<0&&(b+=n.points.length),s=n.points[i].x+c*b,h=n.points[i].y+g*b,(p=(n.points[v].x-s)*(n.points[v].x-s)+(n.points[v].y-h)*(n.points[v].y-h))>a&&(u=!1),p>d&&(l=v,d=p),v=(v+1)%n.points.length}if(u)return[new t.Line(r?new t.Point(n.points[i].x,n.points[i].y):new t.Point(n.points[o].x,n.points[o].y))];var y=l;u=!0,d=0;var x=(y-i)/f,m=(1-x)*(1-x),w=2*(1-x)*x,M=x*x,_=(m*n.points[i].x+M*n.points[o].x-n.points[y].x)/-w,P=(m*n.points[i].y+M*n.points[o].y-n.points[y].y)/-w;for(v=i+1;v!=o;)w=2*(1-(x=(v-i)/f))*x,M=x*x,s=(m=(1-x)*(1-x))*n.points[i].x+w*_+M*n.points[o].x,h=m*n.points[i].y+w*P+M*n.points[o].y,(p=(n.points[v].x-s)*(n.points[v].x-s)+(n.points[v].y-h)*(n.points[v].y-h))>e&&(u=!1),p>d&&(l=v,d=p),v=(v+1)%n.points.length;if(u)return[new t.QuadraticCurve([new t.Point(_,P),new t.Point(n.points[o].x,n.points[o].y)])];var O=y;return this._fitseq(n,i,O,r).concat(this._fitseq(n,O,o,r))},a._complementCommand=function(t,n){for(var i=t[n],o=[],r=0;r<i.holechildren.length;r++)o.push.apply(o,t[i.holechildren[r]].holeCommands);return o},a._createPaths=function(n){for(var o=[],r=0;r<n.length;r++)for(var a=0;a<n[r].length;a++){var e=n[r],s=e[a];if(!(s.isholepath||s.commands.length<this.commandOmit)){var h=this.palettes[r],p="rgb("+h.r+", "+h.g+", "+h.b+")",l=new t.Path(i({},this.pathAttrs,{stroke:p,fill:p,opacity:String(h.a/255)}));l.addCommand([].concat(s.commands,this._complementCommand(e,a))),o.push(l)}}return o},r}();exports.Blur=a,exports.ImgLoader=e,exports.ImgTrace=m,exports.Palette=s;
//# sourceMappingURL=index.cjs.map
