/*
 * @svg-drawing/img-trace v5.0.1-beta.0 
 * 
 * Copyright (C) Kazuto Kamei.
 * This source code is licensed under the MIT license.
 */
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("@svg-drawing/core")):"function"==typeof define&&define.amd?define(["exports","@svg-drawing/core"],n):n((t="undefined"!=typeof globalThis?globalThis:t||self).SVGDImgTrace={},t.SVGDCore)}(this,(function(t,n){"use strict";function i(t,n,i){return n in t?Object.defineProperty(t,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[n]=i,t}function o(){return o=Object.assign||function(t){for(var n=1;n<arguments.length;n++){var i=arguments[n];for(var o in i)Object.prototype.hasOwnProperty.call(i,o)&&(t[o]=i[o])}return t},o.apply(this,arguments)}var r=function(t){var n=t.width*t.height;if(!(t.data.length<4*n))return t;for(var i=new Uint8ClampedArray(4*n),r=0;r<n;r++)i[4*r]=t.data[3*r],i[4*r+1]=t.data[3*r+1],i[4*r+2]=t.data[3*r+2],i[4*r+3]=255;return o({},t,{data:i})},a=[[.27901,.44198,.27901],[.135336,.228569,.272192,.228569,.135336],[.086776,.136394,.178908,.195843,.178908,.136394,.086776],[.063327,.093095,.122589,.144599,.152781,.144599,.122589,.093095,.063327],[.049692,.069304,.089767,.107988,.120651,.125194,.120651,.107988,.089767,.069304,.049692]],e=function(){function t(t){var n=t.radius,o=t.delta;i(this,"radius",void 0),i(this,"delta",void 0),this.radius=null!=n?n:0,this.delta=null!=o?o:20}return t.prototype.apply=function(t){var n=r(t),i=new Uint8ClampedArray(n.data),o=Math.floor(this.radius);if(o<1)return n;o>a.length&&(o=a.length);var e=Math.abs(this.delta);e>1024&&(e=1024);for(var s=a[o-1],h=0;h<n.height;h++)for(var l=0;l<n.width;l++){for(var p=0,d=0,u=0,f=0,c=0,g=-o;g<o+1;g++)if(l+g>0&&l+g<n.width){var v=4*(h*n.width+l+g);p+=n.data[v]*s[g+o],d+=n.data[v+1]*s[g+o],u+=n.data[v+2]*s[g+o],f+=n.data[v+3]*s[g+o],c+=s[g+o]}var b=4*(h*n.width+l);i[b]=Math.floor(p/c),i[b+1]=Math.floor(d/c),i[b+2]=Math.floor(u/c),i[b+3]=Math.floor(f/c)}for(var y=new Uint8ClampedArray(i),m=0;m<n.height;m++)for(var x=0;x<n.width;x++){for(var w=0,M=0,_=0,P=0,C=0,O=-o;O<o+1;O++)if(m+O>0&&m+O<n.height){var q=4*((m+O)*n.width+x);w+=y[q]*s[O+o],M+=y[q+1]*s[O+o],_+=y[q+2]*s[O+o],P+=y[q+3]*s[O+o],C+=s[O+o]}var A=4*(m*n.width+x);i[A]=Math.floor(w/C),i[A+1]=Math.floor(M/C),i[A+2]=Math.floor(_/C),i[A+3]=Math.floor(P/C)}for(var I=0;I<n.height;I++)for(var D=0;D<n.width;D++){var S=4*(I*n.width+D);Math.abs(i[S]-n.data[S])+Math.abs(i[S+1]-n.data[S+1])+Math.abs(i[S+2]-n.data[S+2])+Math.abs(i[S+3]-n.data[S+3])>e&&(i[S]=n.data[S],i[S+1]=n.data[S+1],i[S+2]=n.data[S+2],i[S+3]=n.data[S+3])}return new ImageData(i,n.width,n.height)},t}(),s=function(){function t(t){var n;i(this,"corsenabled",void 0),this.corsenabled=null==(n=t.corsenabled)||n}var n=t.prototype;return n.fromUrl=function(t,n){var i=this,o=function(n,o){var r=new Image;i.corsenabled&&(r.crossOrigin="Anonymous"),r.onload=function(){i.fromImageElement(r,n)},r.onerror=function(t){o?o(t):console.error(t)},r.src=t};if(!n)return new Promise(o);o(n)},n.fromImageElement=function(t,n){var i=function(n,i){var o=document.createElement("canvas");o.width=t.naturalWidth||t.width,o.height=t.naturalHeight||t.height;var r=o.getContext("2d");null==r||r.drawImage(t,0,0);var a=null==r?void 0:r.getImageData(0,0,o.width,o.height);if(!a){if(i)return void i("error canvas context.");throw"error canvas context."}n(a)};if(!n)return new Promise(i);i(n)},t}(),h=function(){function t(){}return t.imageData=function(t,n){for(var i=void 0===n?{}:n,o=i.numberOfColors||16,a=i.colorQuantCycles||3,e=r(t),s=this._deterministic(e,o),h=[],l=0;l<a;l++){if(l>0)for(var p=0;p<s.length;p++)h[p].n>0&&(s[p]={r:Math.floor(h[p].r/h[p].n),g:Math.floor(h[p].g/h[p].n),b:Math.floor(h[p].b/h[p].n),a:Math.floor(h[p].a/h[p].n)});h=Array.from({length:s.length},(function(){return{r:0,g:0,b:0,a:0,n:0}}));for(var d=0;d<e.height;d++)for(var u=function(t){var n=4*(d*e.width+t),i=1024,o=s.reduce((function(t,o,r){var a=Math.abs(o.r-e.data[n])+Math.abs(o.g-e.data[n+1])+Math.abs(o.b-e.data[n+2])+Math.abs(o.a-e.data[n+3]);return a<i?(i=a,r):t}),0);h[o].r+=e.data[n],h[o].g+=e.data[n+1],h[o].b+=e.data[n+2],h[o].a+=e.data[n+3],h[o].n+=1},f=0;f<e.width;f++)u(f)}return s},t._deterministic=function(t,n){for(var i=[],o=Math.ceil(Math.sqrt(n)),r=Math.ceil(n/o),a=t.width/(o+1),e=t.height/(r+1),s=0;s<r;s++)for(var h=0;h<o&&i.length!==n;h++){var l=4*Math.floor((s+1)*e*t.width+(h+1)*a);i.push({r:t.data[l],g:t.data[l+1],b:t.data[l+2],a:t.data[l+3]})}return i},t.number=function(t){if(void 0===t&&(t=16),t<8)return this.grey(t);for(var n=[],i=Math.floor(Math.pow(t,1/3)),o=Math.floor(255/(i-1)),r=0;r<i;r+=1)for(var a=0;a<i;a+=1)for(var e=0;e<i;e+=1)n.push({r:r*o,g:a*o,b:e*o,a:255});for(var s=t-i*i*i,h=0;h<s;h++)n.push({r:Math.floor(255*Math.random()),g:Math.floor(255*Math.random()),b:Math.floor(255*Math.random()),a:Math.floor(255*Math.random())});return n},t.grey=function(t){void 0===t&&(t=16);for(var n=[],i=Math.floor(255/(t-1)),o=0;o<t;o++)n.push({r:o*i,g:o*i,b:o*i,a:255});return n},t}(),l=0,p=1,d=2,u=3,f=4,c=5,g=6,v=7,b=8,y=-1,m=[[[-1,-1,-1,-1],[-1,-1,-1,-1],[-1,-1,-1,-1],[-1,-1,-1,-1]],[[0,1,0,-1],[-1,-1,-1,-1],[-1,-1,-1,-1],[0,2,-1,0]],[[-1,-1,-1,-1],[-1,-1,-1,-1],[0,1,0,-1],[0,0,1,0]],[[0,0,1,0],[-1,-1,-1,-1],[0,2,-1,0],[-1,-1,-1,-1]],[[-1,-1,-1,-1],[0,0,1,0],[0,3,0,1],[-1,-1,-1,-1]],[[13,3,0,1],[13,2,-1,0],[7,1,0,-1],[7,0,1,0]],[[-1,-1,-1,-1],[0,1,0,-1],[-1,-1,-1,-1],[0,3,0,1]],[[0,3,0,1],[0,2,-1,0],[-1,-1,-1,-1],[-1,-1,-1,-1]],[[0,3,0,1],[0,2,-1,0],[-1,-1,-1,-1],[-1,-1,-1,-1]],[[-1,-1,-1,-1],[0,1,0,-1],[-1,-1,-1,-1],[0,3,0,1]],[[11,1,0,-1],[14,0,1,0],[14,3,0,1],[11,2,-1,0]],[[-1,-1,-1,-1],[0,0,1,0],[0,3,0,1],[-1,-1,-1,-1]],[[0,0,1,0],[-1,-1,-1,-1],[0,2,-1,0],[-1,-1,-1,-1]],[[-1,-1,-1,-1],[-1,-1,-1,-1],[0,1,0,-1],[0,0,1,0]],[[0,1,0,-1],[-1,-1,-1,-1],[-1,-1,-1,-1],[0,2,-1,0]],[[-1,-1,-1,-1],[-1,-1,-1,-1],[-1,-1,-1,-1],[-1,-1,-1,-1]]],x=[{r:0,g:0,b:0,a:255},{r:50,g:50,b:50,a:255},{r:100,g:100,b:100,a:255},{r:150,g:150,b:150,a:255},{r:200,g:200,b:200,a:255}],w=function(){function t(t){var n,r,a,e,s;void 0===t&&(t={}),i(this,"ltres",void 0),i(this,"qtres",void 0),i(this,"rightangleenhance",void 0),i(this,"pathOmit",void 0),i(this,"commandOmit",void 0),i(this,"pathAttrs",void 0),i(this,"palettes",void 0),this.ltres=null!=(n=t.ltres)?n:1,this.qtres=null!=(r=t.qtres)?r:1,this.rightangleenhance=null==(a=t.rightangleenhance)||a,this.pathOmit=null!=(e=t.pathOmit)?e:8,this.commandOmit=null!=(s=t.commandOmit)?s:0,this.pathAttrs=o({strokeWidth:"1"},t.pathAttrs||{}),this.palettes=t.palettes||x}var a=t.prototype;return a.load=function(t){for(var i=r(t),o=this._colorQuantization(i),a=[],e=0;e<this.palettes.length;e++){var s=this._edgeDetection(o,e),h=this._pathScan(s),l=this._interpolation(h).map(this._tracePath.bind(this));a.push(l)}var p=this._createPaths(a);return new n.Svg({width:o[0].length-2,height:o.length-2}).addPath(p)},a._colorQuantization=function(t){var n=this;return Array.from({length:t.height+2},(function(i,o){return Array.from({length:t.width+2},(function(i,r){if(0===r||r===t.width+1||0===o||o===t.height+1)return-1;var a=r-1,e=4*((o-1)*t.width+a);return n._findPaletteIndex({r:t.data[e],g:t.data[e+1],b:t.data[e+2],a:t.data[e+3]})}))}))},a._findPaletteIndex=function(t){var n=t.r,i=t.g,o=t.b,r=t.a,a=1024;return this.palettes.reduce((function(t,e,s){var h=Math.abs(e.r-n)+Math.abs(e.g-i)+Math.abs(e.b-o)+Math.abs(e.a-r);return h<a?(a=h,s):t}),0)},a._edgeDetection=function(t,n){for(var i=[],o=t.length,r=t[0].length,a=0;a<o;a++){i[a]=[];for(var e=0;e<r;e++)i[a][e]=0===a||0===e?0:(t[a-1][e-1]===n?1:0)+(t[a-1][e]===n?2:0)+(t[a][e-1]===n?8:0)+(t[a][e]===n?4:0)}return i},a._pointpoly=function(t,n){for(var i=!1,o=0,r=n.length-1;o<n.length;r=o++)i=n[o].y>t.y!=n[r].y>t.y&&t.x<(n[r].x-n[o].x)*(t.y-n[o].y)/(n[r].y-n[o].y)+n[o].x?!i:i;return i},a._pathScan=function(t){for(var n=t[0].length,i=t.length,o=[],r=0,a=0;a<i;a++)for(var e=0;e<n;e++){var s=t[a][e];if(4===s||11===s){var h=e,l=a,p=1,d=0,u=!1;for(o[r]={points:[],boundingbox:[h,l,h,l],holechildren:[],isholepath:!1};!u;){o[r].points[d]={x:h-1,y:l-1,direction:y},h-1<o[r].boundingbox[0]&&(o[r].boundingbox[0]=h-1),h-1>o[r].boundingbox[2]&&(o[r].boundingbox[2]=h-1),l-1<o[r].boundingbox[1]&&(o[r].boundingbox[1]=l-1),l-1>o[r].boundingbox[3]&&(o[r].boundingbox[3]=l-1);var f=m[t[l][h]][p];if(t[l][h]=f[0],p=f[1],h+=f[2],l+=f[3],h-1===o[r].points[0].x&&l-1===o[r].points[0].y)if(u=!0,o[r].points.length<this.pathOmit)o.pop();else{if(11===s){o[r].isholepath=!0;for(var c=0,g=[-1,-1,n+1,i+1],v=0;v<r;v++)!o[v].isholepath&&this._boundingboxincludes(o[v].boundingbox,o[r].boundingbox)&&this._boundingboxincludes(g,o[v].boundingbox)&&this._pointpoly(o[r].points[0],o[v].points)&&(c=v,g=o[v].boundingbox);o[c].holechildren.push(r)}r++}d++}}}return o},a._boundingboxincludes=function(t,n){return t[0]<n[0]&&t[1]<n[1]&&t[2]>n[2]&&t[3]>n[3]},a._interpolation=function(t){for(var n=[],i=0,o=0,r=0,a=0,e=0;e<t.length;e++){n[e]={points:[],boundingbox:t[e].boundingbox,holechildren:t[e].holechildren,isholepath:t[e].isholepath};for(var s=t[e].points.length,h=0;h<s;h++)i=(h+1)%s,o=(h+2)%s,r=(h-1+s)%s,a=(h-2+s)%s,this.rightangleenhance&&this._testrightangle(t[e],a,r,h,i,o)&&(n[e].points.length>0&&(n[e].points[n[e].points.length-1].direction=this._getdirection(n[e].points[n[e].points.length-1].x,n[e].points[n[e].points.length-1].y,t[e].points[h].x,t[e].points[h].y)),n[e].points.push({x:t[e].points[h].x,y:t[e].points[h].y,direction:this._getdirection(t[e].points[h].x,t[e].points[h].y,(t[e].points[h].x+t[e].points[i].x)/2,(t[e].points[h].y+t[e].points[i].y)/2)})),n[e].points.push({x:(t[e].points[h].x+t[e].points[i].x)/2,y:(t[e].points[h].y+t[e].points[i].y)/2,direction:this._getdirection(t[e].points[h].x+t[e].points[i].x,t[e].points[h].y+t[e].points[i].y,t[e].points[i].x+t[e].points[o].x,t[e].points[i].y+t[e].points[o].y)})}return n},a._testrightangle=function(t,n,i,o,r,a){return t.points[o].x===t.points[n].x&&t.points[o].x===t.points[i].x&&t.points[o].y===t.points[r].y&&t.points[o].y===t.points[a].y||t.points[o].y===t.points[n].y&&t.points[o].y===t.points[i].y&&t.points[o].x===t.points[r].x&&t.points[o].x===t.points[a].x},a._getdirection=function(t,n,i,o){return t<i?n<o?p:v:t>i?n<o?u:n>o?c:f:n<o?d:n>o?g:b},a._tracePath=function(t){for(var i=0,o=[],r=[];i<t.points.length;){for(var a=t.points[i].direction,e=y,s=i+1;(t.points[s].direction===a||t.points[s].direction===e||-1===e)&&s<t.points.length-1;)t.points[s].direction!==a&&e===y&&(e=t.points[s].direction||l),s++;s===t.points.length-1?(o.push.apply(o,this._fitseq(t,i,0)),r.push.apply(r,this._fitseq(t,i,0,!0)),i=t.points.length):(o.push.apply(o,this._fitseq(t,i,s)),r.push.apply(r,this._fitseq(t,i,s,!0)),i=s)}var h=[new n.Move(new n.Point(t.points[0].x,t.points[0].y))].concat(o,[new n.Close]);r.reverse();var p=r[r.length-1].values.slice(0,2);return{commands:h,holeCommands:[new n.Move(new n.Point(p[0],p[1]))].concat(r,[new n.Close]),holechildren:t.holechildren,isholepath:t.isholepath}},a._fitseq=function(t,i,o,r){var a=this.ltres,e=this.qtres;if(o>t.points.length||o<0)return[];var s,h,l,p=i,d=0,u=!0,f=o-i;f<0&&(f+=t.points.length);for(var c=(t.points[o].x-t.points[i].x)/f,g=(t.points[o].y-t.points[i].y)/f,v=(i+1)%t.points.length;v!=o;){var b=v-i;b<0&&(b+=t.points.length),s=t.points[i].x+c*b,h=t.points[i].y+g*b,(l=(t.points[v].x-s)*(t.points[v].x-s)+(t.points[v].y-h)*(t.points[v].y-h))>a&&(u=!1),l>d&&(p=v,d=l),v=(v+1)%t.points.length}if(u)return[new n.Line(r?new n.Point(t.points[i].x,t.points[i].y):new n.Point(t.points[o].x,t.points[o].y))];var y=p;u=!0,d=0;var m=(y-i)/f,x=(1-m)*(1-m),w=2*(1-m)*m,M=m*m,_=(x*t.points[i].x+M*t.points[o].x-t.points[y].x)/-w,P=(x*t.points[i].y+M*t.points[o].y-t.points[y].y)/-w;for(v=i+1;v!=o;)w=2*(1-(m=(v-i)/f))*m,M=m*m,s=(x=(1-m)*(1-m))*t.points[i].x+w*_+M*t.points[o].x,h=x*t.points[i].y+w*P+M*t.points[o].y,(l=(t.points[v].x-s)*(t.points[v].x-s)+(t.points[v].y-h)*(t.points[v].y-h))>e&&(u=!1),l>d&&(p=v,d=l),v=(v+1)%t.points.length;if(u)return[new n.QuadraticCurve([new n.Point(_,P),new n.Point(t.points[o].x,t.points[o].y)])];var C=y;return this._fitseq(t,i,C,r).concat(this._fitseq(t,C,o,r))},a._complementCommand=function(t,n){for(var i=t[n],o=[],r=0;r<i.holechildren.length;r++)o.push.apply(o,t[i.holechildren[r]].holeCommands);return o},a._createPaths=function(t){for(var i=[],r=0;r<t.length;r++)for(var a=0;a<t[r].length;a++){var e=t[r],s=e[a];if(!(s.isholepath||s.commands.length<this.commandOmit)){var h=this.palettes[r],l="rgb("+h.r+", "+h.g+", "+h.b+")",p=new n.Path(o({},this.pathAttrs,{stroke:l,fill:l,opacity:String(h.a/255)}));p.addCommand([].concat(s.commands,this._complementCommand(e,a))),i.push(p)}}return i},t}();t.Blur=e,t.ImgLoader=s,t.ImgTrace=w,t.Palette=h,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.js.map
